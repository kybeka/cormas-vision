<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phone Camera → Laptop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark light;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: #0b0b10;
      color: #f5f5f5;
      display: flex;
      min-height: 100vh;
      justify-content: center;
      align-items: stretch;
    }
    .shell {
      width: 100%;
      max-width: 480px;
      margin: auto;
      padding: 16px;
      box-sizing: border-box;
    }
    .card {
      background: rgba(20, 20, 30, 0.96);
      border-radius: 18px;
      padding: 16px 16px 20px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
    }
    h1 {
      font-size: 1.2rem;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-bottom: 12px;
    }
    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    button {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    #startBtn {
      background: #3b82f6;
      color: white;
    }
    #startBtn:disabled {
      opacity: 0.5;
    }
    #stopBtn {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    #stopBtn:disabled {
      opacity: 0.4;
    }
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 0.8rem;
    }
    .row label {
      flex: 1.5;
      opacity: 0.85;
    }
    .row input {
      flex: 1;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      font-size: 0.85rem;
      text-align: center;
    }
    .status {
      font-size: 0.78rem;
      opacity: 0.8;
      min-height: 1.2em;
      margin-bottom: 8px;
    }
    video {
      width: 100%;
      border-radius: 14px;
      background: #000;
      margin-top: 6px;
    }
    .footer {
      margin-top: 10px;
      font-size: 0.7rem;
      opacity: 0.6;
      text-align: center;
    }
    @media (prefers-color-scheme: light) {
      body { background: #f1f5f9; color: #020617; }
      .card { background: #ffffff; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12); }
      #stopBtn { background: #f9fafb; color: #111827; }
      .row input { background: #f9fafb; color: #020617; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <h1>Phone Camera → Laptop</h1>
      <div class="subtitle">Streams frames over HTTPS to your computer.</div>

      <div class="row">
        <label for="intervalMs">Capture interval (ms)</label>
        <input id="intervalMs" type="number" min="50" step="10" value="200" />
      </div>

      <div class="controls">
        <button id="startBtn">Start streaming</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>

      <div class="status" id="status">Idle.</div>

      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none;"></canvas>

      <div class="footer">
        Keep this page open while recording. Each run is stored in a new timestamped folder under <code>frames/</code>.
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const statusEl = document.getElementById("status");
    const intervalInput = document.getElementById("intervalMs");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    let captureTimer = null;
    let sentCount = 0;

    function logStatus(msg) {
      statusEl.textContent = msg;
      console.log(msg);
    }

    async function startStreaming() {
      const intervalMs = parseInt(intervalInput.value, 10) || 200;

      // 1) Ask server to start a new session (server handles ID + folder)
      try {
        const resp = await fetch("/start_session", { method: "POST" });
        if (!resp.ok) {
          logStatus("Failed to start session on server.");
          return;
        }
      } catch (err) {
        console.error(err);
        logStatus("Error contacting server: " + err.message);
        return;
      }

      // 2) Camera
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        logStatus("Camera started.");
      } catch (err) {
        console.error(err);
        logStatus("Error accessing camera: " + err.message);
        return;
      }

      const width = video.videoWidth || 640;
      const height = video.videoHeight || 480;
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");

      startBtn.disabled = true;
      stopBtn.disabled = false;
      sentCount = 0;

      // 3) Periodically capture & POST frame
      captureTimer = setInterval(async () => {
        try {
          ctx.drawImage(video, 0, 0, width, height);
          const dataUrl = canvas.toDataURL("image/jpeg", 0.6);

          await fetch("/upload_frame", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: dataUrl
          });

          sentCount++;
          logStatus(`Frames sent: ${sentCount}`);
        } catch (err) {
          console.error(err);
          logStatus("Send error: " + err.message);
        }
      }, intervalMs);
    }

    function stopStreaming() {
      if (captureTimer) {
        clearInterval(captureTimer);
        captureTimer = null;
      }

      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }

      startBtn.disabled = false;
      stopBtn.disabled = true;
      logStatus("Stopped.");
    }

    startBtn.addEventListener("click", startStreaming);
    stopBtn.addEventListener("click", stopStreaming);
  </script>
</body>
</html>
